---
title: "XML Vignette"
author: "Ryan McGovern and Steve Sortijas"
date: "June 6, 2019"
output: rmarkdown::github_document
---


Text describing xml format needed...

Text describing data set...

For this vignette we will use a dataset consisting of mortality rates and life expectancy rates at birth by race and sex in the U.S. from 1900 to 2015. This data set is publicly available from the CDC. https://data.cdc.gov/NCHS/NCHS-Death-rates-and-life-expectancy-at-birth/w9j2-ggv5  

Text from CDC describing data collection methods....

Age-adjusted death rates (deaths per 100,000) after 1998 are calculated based on the 2000 U.S. standard population. Populations used for computing death rates for 2011â€“2015 are postcensal estimates based on the 2010 census, estimated as of July 1, 2010. Rates for census years are based on populations enumerated in the corresponding censuses. Rates for noncensus years between 2000 and 2010 are revised using updated intercensal population estimates and may differ from rates previously published. Data on age-adjusted death rates prior to 1999 are taken from historical data (see References below).

Life expectancy data are available up to 2014. Due to changes in categories of race used in publications, data are not available for the black population consistently before 1968, and not at all before 1960. More information on historical data on age-adjusted death rates is available at https://www.cdc.gov/nchs/nvss/mortality/hist293.htm.

Packages for managing XML data

In this vignette we will use the XML package for parsing and processing XML data. Another package called "xml2" is also available for managing XML and HTML data. Both packages are available in CRAN. The XML package is the better documented of the two packages and the list of functions in XML is greater than in xml2. For instance the XML package offers functions for transforming XML data to data frames and lists, whereas xml2 does not offer such functionality.

However, XML does have its particularities. Thankfully, because it is well-documented, solutions are more easy to find. For instance, we use the httr package in calling the data from the CDC URL because simply using the URL alone for this particular function resulted in an error. Whereas, for the xml2 package, simply using the URL did not result in an error.

```{r ImportDeathData}
#Load all necessary packages
library(XML)
library(httr)
library(tidyverse)

#Create URL character string object
url <- "https://data.cdc.gov/api/views/w9j2-ggv5/rows.xml"

#Use xmlParse function (XML) with GET function (httr) to parse XML data; n.b. not using GET function results in error message indicating content is not XML
doc <- xmlParse(GET(url))

#Create object to identify root node of XML data
root <- xmlRoot(doc)

#Use xmlToDataFrame function (XML) with selected root node to create data frame; n.b. not subsetting the root node results in an error
ds<-xmlToDataFrame(root[[1]])

#All variables are character; convert variables which should be numeric
ds[,4:5]<-sapply(ds[,4:5],as.numeric)

#create the variable for decade
ds <- mutate(ds, decade=as.numeric(substr(year,1,3))*10)
```

```{r tables}
#after making the plots i think a good chart would be the DIFFERFENCE in avg life expectancy by gender and decade

#Average life expectancy by decade, filtered by "All races", "Female", and "Male"
avgALEDecade <- ds %>% filter(race=="All Races" & sex %in% c("Female","Male")) %>% group_by(sex,decade) %>% summarise(avgALE = mean(average_life_expectancy, na.rm=TRUE))

#Sex by decade table
avgALESex <- avgALEDecade %>% spread(key = decade, value = avgALE)

#Bind difference between average life expectancies
avgALESexDiff <- bind_rows(avgALESex,avgALESex[avgALESex$sex=="Female",2:13]-avgALESex[avgALESex$sex=="Male",2:13])

#add a value for difference
avgALESexDiff[3,1] <- 'Difference'

knitr::kable(avgALESexDiff, caption = "Average life expectancy by sex by decade")

```
```{r getIQR_Function}
#create the requested IQR function
#Have your function check if the passed value is numeric and if it is appropriate for this argument (i.e. is a vector or a data frame/tibble with only one column) - if not, stop the function and return an appropriate message.

getIQR <- function(vector, ...) 
  #check that the value given is numeric and a vector
   if (is.vector(vector) & is.numeric(vector)){
    IQR <- quantile(vector, probs =  0.75 , names = FALSE, ...) - quantile(vector, probs =  0.25, names = FALSE, ... )  
    return(list(IQR = IQR))
    #if we are given a data frame we can convert this to a data vector
   }else if (is.data.frame(vector) & is.numeric(as.numeric(vector[,1]))){
     #since this is a data frame we will convert it to a vector
     conv_vector <- as.numeric(vector[,1])
    IQR <- quantile(conv_vector, probs =  0.75 , names = FALSE, ...) - quantile(conv_vector, probs =  0.25, names = FALSE, ... )  
    return(list(IQR = IQR))
} else {stop("Value is not numeric")}

```

```{r DecadeDiffRace_function, include = FALSE}
#this function will create the differance in life expectancy table by a supplied race
DD_Race <- function(char_race) {
  #if we arent given a character stop the function
  if (is.character(char_race) == 0) {stop("Value is not a character")}

#Average life expectancy by decade, filtered by "All races", "Female", and "Male"
avgALEDecade <- ds %>% filter(race==char_race & sex %in% c("Female","Male")) %>% group_by(sex,decade) %>% summarise(avgALE = mean(average_life_expectancy, na.rm=TRUE))

#Sex by decade table
avgALESex <- avgALEDecade %>% spread(key = decade, value = avgALE)

#Bind difference between average life expectancies
avgALESexDiff <- bind_rows(avgALESex,avgALESex[avgALESex$sex=="Female",2:13]-avgALESex[avgALESex$sex=="Male",2:13])

#add a value for difference
avgALESexDiff[3,1] <- 'Difference'

knitr::kable(avgALESexDiff, caption = paste('Average life expectancy by sex by decade :', char_race))
}
```

```{r dd race call}
#call the function for each race
DD_Race('Black')
DD_Race('White')
DD_Race('All Races')
```


```{r AvgLifeExpByDecade Chart}
#Question about calculations: does "all races" category mean black and white combined? If so, then should we just use the "all races" data for the 2 graphs below where race is not part of the visualization?

#calculate the average life exp by decade and gender
chart_1_Data <- ds %>% filter(sex %in% 
c("Female", "Male")) %>% group_by(decade, sex) %>% summarise(avgAgeDecade = mean(average_life_expectancy, na.rm = TRUE))

g <- ggplot(chart_1_Data, aes(x = decade, fill = sex, weight=avgAgeDecade))
g + geom_bar(position = "dodge") + xlab("Decade") +ylab("Average Life Expectancy")+scale_fill_discrete(name = "Gender")

```

```{r Chart2, echo=FALSE}
#create the scatterplot of age by year 
chart_2_Data <- ds %>% filter(sex %in% c("Female", "Male"))
g <- ggplot(data = chart_2_Data, aes(x = year, y = average_life_expectancy))
g + geom_smooth(method = lm, aes(group=sex), show.legend =FALSE, col="green") +geom_point(aes(col=sex)) +  ggtitle("Average Life Expectancy by Gender and age") + xlab("Year") +ylab("Average Life Expectancy")+scale_fill_discrete(name = "Gender")

```


```{r chart3}
#boxplot for sepal length
chart_3_Data <- ds %>% filter(sex %in% c("Female", "Male"))

g <- ggplot(data = chart_3_Data, aes(x = race, y=average_life_expectancy))
g + geom_boxplot() + scale_x_discrete(name = "Gender") + ggtitle("Boxplot Average Life Expectancy") + geom_point(aes(col=sex), position = 'jitter')
```

```{r chart4}
#boxplot for sepal length
chart_3_Data <- ds %>% filter(sex %in% c("Female", "Male"))

g <- ggplot(data = chart_3_Data, aes(x = race, y=average_life_expectancy))
g + geom_boxplot() + ggtitle("Boxplot Average Life Expectancy") + facet_wrap(~ sex)
```

```{r mortalityGraphs}

#Faceted scatterplot chart
ggplot(ds, aes(x=as.numeric(year), y=mortality)) + geom_point(aes(color=race)) + facet_grid(~sex) + labs(x="Year", y="Mortality Rate (deaths per 100,000)", color="", title="Mortality Rates by Sex and Race, 1900-2015")

```

