---
title: "XML Vignette"
author: "Ryan McGovern and Steve Sortijas"
date: "June 6, 2019"
output: rmarkdown::github_document
---

# Introduction

## XML Data

In this project we use R to process and conduct exploratory data analysis on a publicly available XML dataset. XML, or Extensible Markup Language, is an open standard markup language that is designed to carry data and to enable compatibility. Unlike HTML, it uses tags which are user-defined and new tags can be created as new data is added without redefining existing tags. XML data is highly portable because it stored in plain text, using a common standard which is not hardware or software dependent. XML is widely used in the development of document formats and industry data standards. This project uses XML data from Data.gov.

## Processing XML Data in R

In this vignette we will use the XML package for parsing and processing XML data. Another package called "xml2" is also available for managing XML and HTML data. Both packages are available in CRA and xml2 is part of the tidyverse. The XML package is the better documented of the two packages and the list of functions in XML is greater than in xml2. For instance the XML package offers functions for transforming XML data to data frames and lists, whereas xml2 does not offer such functionality.

However, XML does have its particularities. Because it is well-documented, troubleshooting is often simpler. For instance, we use the httr package in calling the data because simply using the URL alone for this particular function resulted in an error. Whereas, for the xml2 package, simply using the URL did not result in an error.

Using the XML package we use only 3 functions: xmlParse, xmlRoot, and xmlToDataFrame. As the name would suggest, xmlParse parses XML content and generates an R object representing an XML tree. This particular function uses the internal nodes by default. xmlRoot is then used to identify the root node. By subsetting the root node in an object, we can then apply the xmlToDataSet function to transform the xml dataset to an R data frame.

## Dataset Information

For this vignette we will use a dataset consisting of mortality rates and life expectancy rates at birth by race and sex in the U.S. from 1900 to 2015. This data set is publicly available from the [CDC](https://data.cdc.gov/NCHS/NCHS-Death-rates-and-life-expectancy-at-birth/w9j2-ggv5).  

This dataset consists of 1044 observations with 5 variables: year, race, sex, mortality, and average_life_expectancy. The dataset is in "long" form. Year, race, and sex are the groupings which contain values for mortality rates and average life expectancy rates. Year is inclusive of every year from 1900 to 2015. Race is a categorical variable consisting of: All Races, Black, and White. Although it is not explicit in CDC's description of the data, we presume that the All Races category is Black and White combined. Sex is a categorical variable consisting of: Both Sexes, Female, and Male. Mortality rate (mortality), or age-adjusted death rates is a numerical variable representing the number deaths per 100,000. The link above describes in detail how mortality rates are calculated for various historical periods. Life expectancy rate (average_life_expectancy) is a numerical variable denominated in years. Per [CDC](https://www.cdc.gov/nchs/nvss/mortality/hist293.htm.), life expectancy data are available up to 2014 and are not consistently available for the black population before 1968. The average_life_expectancy variable is the only one which contains NAs.
 

```{r ImportDeathData, include=FALSE}
#Load all necessary packages
library(XML)
library(httr)
library(tidyverse)

#Create URL character string object
url <- "https://data.cdc.gov/api/views/w9j2-ggv5/rows.xml"

#Use xmlParse function (XML) with GET function (httr) to parse XML data; n.b. not using GET function results in error message indicating content is not XML
doc <- xmlParse(GET(url))

#Create object to identify root node of XML data
root <- xmlRoot(doc)

#Use xmlToDataFrame function (XML) with selected root node to create data frame; n.b. not subsetting the root node results in an error
ds<-xmlToDataFrame(root[[1]])

#All variables are character; convert variables which should be numeric
ds[,4:5]<-sapply(ds[,4:5],as.numeric)

#create the variable for decade
ds <- mutate(ds, decade=as.numeric(substr(year,1,3))*10)
```

# Life expectancy

## Average Life Expectency by Gender and Decade 

```{r tables, echo=FALSE}
#after making the plots i think a good chart would be the DIFFERFENCE in avg life expectancy by gender and decade

#Average life expectancy by decade, filtered by "All races", "Female", and "Male"
avgALEDecade <- ds %>% filter(race=="All Races" & sex %in% c("Female","Male")) %>% group_by(sex,decade) %>% summarise(avgALE = mean(average_life_expectancy, na.rm=TRUE))

#Sex by decade table
avgALESex <- avgALEDecade %>% spread(key = decade, value = avgALE)

#Bind difference between average life expectancies
avgALESexDiff <- bind_rows(avgALESex,avgALESex[avgALESex$sex=="Female",2:13]-avgALESex[avgALESex$sex=="Male",2:13])

#add a value for difference
avgALESexDiff[3,1] <- 'Difference'

knitr::kable(avgALESexDiff, caption = "Average life expectancy by sex by decade")

```

```{r DecadeDiffRace_function, echo=FALSE}
#this function will create the differance in life expectancy table by a supplied race
DD_Race <- function(char_race) {
  #if we arent given a character stop the function
  if (is.character(char_race) == 0) {stop("Value is not a character")}

#Average life expectancy by decade, filtered by "All races", "Female", and "Male"
avgALEDecade <- ds %>% filter(race==char_race & sex %in% c("Female","Male")) %>% group_by(sex,decade) %>% summarise(avgALE = mean(average_life_expectancy, na.rm=TRUE))

#Sex by decade table
avgALESex <- avgALEDecade %>% spread(key = decade, value = avgALE)

#Bind difference between average life expectancies
avgALESexDiff <- bind_rows(avgALESex,avgALESex[avgALESex$sex=="Female",2:13]-avgALESex[avgALESex$sex=="Male",2:13])

#add a value for difference
avgALESexDiff[3,1] <- 'Difference'

return(avgALESexDiff)
}
```

## Average Life Expectency by Gender and Decade broken out by Race

comments on tables below that show difference of male/female expected life by race

```{r dd race call, echo=FALSE}
#call the function for each race 
Black <- DD_Race('Black')
knitr::kable(Black, caption ='Average life expectancy by sex by decade: Black')
Black[3,1] = 'Black'

White <-DD_Race('White')
knitr::kable(White, caption ='Average life expectancy by sex by decade: White')
White[3,1] = 'White'

all_races <-DD_Race('All Races')
#commented out as this is duplicative
#knitr::kable(all_races, caption ='Average life expectancy by sex by decade: All Races')
all_races[3,1] = 'All Races'

#create a table of the differences of gender by rate
gender_race_spread <-rbind(Black[3,], White[3,], all_races[3,])
attributes(gender_race_spread)$names[1] <- 'Race'

#plot this as a barchart?
knitr::kable(gender_race_spread, caption = 'Spread of Life Expectancy by Race')

```


```{r AvgLifeExpByDecade Chart, echo=FALSE}
#Question about calculations: does "all races" category mean black and white combined? If so, then should we just use the "all races" data for the 2 graphs below where race is not part of the visualization?

#calculate the average life exp by decade and gender
chart_1_Data <- ds %>% filter(sex %in% 
c("Female", "Male")) %>% group_by(decade, sex) %>% summarise(avgAgeDecade = mean(average_life_expectancy, na.rm = TRUE))

g <- ggplot(chart_1_Data, aes(x = decade, fill = sex, weight=avgAgeDecade))
g + geom_bar(position = "dodge") + xlab("Decade") +ylab("Average Life Expectancy")+scale_fill_discrete(name = "Gender") + ggtitle("Average Life Expectancy by Decade")

```

```{r AvgLifeExpByDecade Chart2, echo=FALSE}
#Question about calculations: does "all races" category mean black and white combined? If so, then should we just use the "all races" data for the 2 graphs below where race is not part of the visualization?

#calculate the average life exp by decade and gender
chart_2_Data <- ds %>% filter(sex %in% 
c("Female", "Male")) %>% group_by(decade, sex, race) %>% summarise(avgAgeDecade = mean(average_life_expectancy, na.rm = TRUE))

g <- ggplot(chart_2_Data, aes(x = decade, fill = sex, weight=avgAgeDecade))
g + geom_bar(position = "dodge") + xlab("Decade") +ylab("Average Life Expectancy")+scale_fill_discrete(name = "Gender") + ggtitle("Average Life Expectancy by Decade and Race") + facet_grid(~race)

```


```{r chart3, warning=FALSE, echo=FALSE}
#boxplot for sepal length
chart_3_Data <- ds %>% filter(sex %in% c("Female", "Male"))

g <- ggplot(data = chart_3_Data, aes(x=race, y=average_life_expectancy, fill=sex))
g + geom_boxplot() + scale_x_discrete(name = "Race") + ggtitle("Boxplot of Average Life Expectancy by Race and Gender") + ylab("Average Life Expectancy") + labs(fill = "Gender")
```

```{r chart4, warning = FALSE, echo=FALSE}
#boxplot for sepal length
chart_3_Data <-gender_race_spread[,1:13]
chart_3_Data <- gather(data=chart_3_Data, key='decade', value='average_life_expectancy', '1900':'2010')

g <- ggplot(data = chart_3_Data, aes(x = decade, y = average_life_expectancy))

g + geom_line(aes(group=Race,linetype = Race )) +  ggtitle("Difference in Average Life Expectency of Genders by Race") + ylab("Difference in Average Life Expectancy between Genders") + xlab("Decade")

```

```{r mortalityGraphs, echo=FALSE}

#Faceted scatterplot chart
ggplot(ds, aes(x=as.numeric(year), y=mortality)) + geom_point(aes(color=race)) + facet_grid(~sex) + labs(x="Decade", y="Mortality Rate (deaths per 100,000)", color="", title="Mortality Rates by Sex and Race, 1900-2015")

```

